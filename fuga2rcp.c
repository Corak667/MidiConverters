// FUGA Systems MIDI -> RCP Converter
// ----------------------------------
// Written by Valley Bell, 05 January 2022
//
// The FUGA MMD/GMD format is basically just RCP without a header.
// In order to convert from (unencrypted) MMD/GMD to RCP, you just have to:
//  - remove the first 6 bytes
//  - insert a 0x586 byte RCP header at the beginning
//  - overwrite offset 0x1C1..0x1C5 with the first 5 bytes of the original file
// and that's it already.
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

#include "stdtype.h"

#ifdef _MSC_VER
#define stricmp	_stricmp
#else
#define stricmp	strcasecmp
#endif


static UINT8 WriteFileData(UINT32 DataLen, const UINT8* Data, const char* FileName);
void DecryptData(UINT32 len, UINT8* data, UINT8 key);
UINT8 Fuga2Rcp(UINT32 songLen, const UINT8* songData);
static UINT16 ReadLE16(const UINT8* data);


static const UINT8 RCP_HEADER[0x0586] =
{
	0x52, 0x43, 0x4D, 0x2D, 0x50, 0x43, 0x39, 0x38, 0x56, 0x32, 0x2E, 0x30, 0x28, 0x43, 0x29, 0x43,	// 0000 RCM-PC98V2.0(C)C
	0x4F, 0x4D, 0x45, 0x20, 0x4F, 0x4E, 0x20, 0x4D, 0x55, 0x53, 0x49, 0x43, 0x0D, 0x0A, 0x00, 0x00,	// 0010 OME ON MUSIC\r\n
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,	// 0020
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
	0x30, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	// 01C0 song information
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x48, 0x61, 0x6E, 0x64, 0x20, 0x43, 0x6C, 0x61, 0x70, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x27, 0x01, 0x4D, 0x74, 0x20, 0x48, 0x69, 0x43, 0x6F, 0x6E, 0x67, 0x61,
	0x20, 0x20, 0x20, 0x20, 0x3E, 0x01, 0x48, 0x69, 0x67, 0x68, 0x20, 0x43, 0x6F, 0x6E, 0x67, 0x61,
	0x20, 0x20, 0x20, 0x20, 0x3F, 0x01, 0x4C, 0x6F, 0x77, 0x20, 0x43, 0x6F, 0x6E, 0x67, 0x61, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x40, 0x01, 0x43, 0x72, 0x61, 0x73, 0x68, 0x20, 0x43, 0x79, 0x6D, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x31, 0x01, 0x52, 0x69, 0x64, 0x65, 0x20, 0x43, 0x79, 0x6D, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x33, 0x01, 0x4F, 0x70, 0x65, 0x6E, 0x48, 0x69, 0x48, 0x61, 0x74, 0x32,
	0x20, 0x20, 0x20, 0x20, 0x2C, 0x01, 0x4F, 0x70, 0x65, 0x6E, 0x48, 0x69, 0x48, 0x61, 0x74, 0x31,
	0x20, 0x20, 0x20, 0x20, 0x2E, 0x01, 0x43, 0x6C, 0x73, 0x64, 0x20, 0x48, 0x69, 0x48, 0x61, 0x74,
	0x20, 0x20, 0x20, 0x20, 0x2A, 0x01, 0x41, 0x63, 0x6F, 0x75, 0x20, 0x48, 0x69, 0x54, 0x6F, 0x6D,
	0x20, 0x20, 0x20, 0x20, 0x30, 0x01, 0x41, 0x63, 0x6F, 0x75, 0x4D, 0x69, 0x64, 0x54, 0x6F, 0x6D,
	0x20, 0x20, 0x20, 0x20, 0x2D, 0x01, 0x41, 0x63, 0x6F, 0x75, 0x4C, 0x6F, 0x77, 0x54, 0x6F, 0x6D,
	0x20, 0x20, 0x20, 0x20, 0x29, 0x01, 0x52, 0x69, 0x6D, 0x20, 0x53, 0x68, 0x6F, 0x74, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x25, 0x01, 0x45, 0x6C, 0x65, 0x63, 0x20, 0x53, 0x44, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x28, 0x01, 0x41, 0x63, 0x6F, 0x75, 0x20, 0x53, 0x44, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x26, 0x01, 0x41, 0x63, 0x6F, 0x75, 0x20, 0x42, 0x44, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x24, 0x01, 0x48, 0x69, 0x20, 0x54, 0x69, 0x6D, 0x62, 0x61, 0x6C, 0x65,
	0x20, 0x20, 0x20, 0x20, 0x41, 0x01, 0x4C, 0x6F, 0x77, 0x54, 0x69, 0x6D, 0x62, 0x61, 0x6C, 0x65,
	0x20, 0x20, 0x20, 0x20, 0x42, 0x01, 0x43, 0x6F, 0x77, 0x62, 0x65, 0x6C, 0x6C, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x38, 0x01, 0x48, 0x69, 0x67, 0x68, 0x20, 0x42, 0x6F, 0x6E, 0x67, 0x6F,
	0x20, 0x20, 0x20, 0x20, 0x3C, 0x01, 0x4C, 0x6F, 0x77, 0x20, 0x42, 0x6F, 0x6E, 0x67, 0x6F, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x3D, 0x01, 0x48, 0x69, 0x67, 0x68, 0x20, 0x41, 0x67, 0x6F, 0x67, 0x6F,
	0x20, 0x20, 0x20, 0x20, 0x43, 0x01, 0x4C, 0x6F, 0x77, 0x20, 0x41, 0x67, 0x6F, 0x67, 0x6F, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x44, 0x01, 0x54, 0x61, 0x6D, 0x62, 0x6F, 0x75, 0x72, 0x69, 0x6E, 0x65,
	0x20, 0x20, 0x20, 0x20, 0x36, 0x01, 0x43, 0x6C, 0x61, 0x76, 0x65, 0x73, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x4B, 0x01, 0x4D, 0x61, 0x72, 0x61, 0x63, 0x61, 0x73, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x46, 0x01, 0x53, 0x6D, 0x62, 0x61, 0x57, 0x68, 0x69, 0x73, 0x20, 0x4C,
	0x20, 0x20, 0x20, 0x20, 0x48, 0x01, 0x53, 0x6D, 0x62, 0x61, 0x57, 0x68, 0x69, 0x73, 0x20, 0x53,
	0x20, 0x20, 0x20, 0x20, 0x47, 0x01, 0x43, 0x61, 0x62, 0x61, 0x73, 0x61, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x45, 0x01, 0x51, 0x75, 0x69, 0x6A, 0x61, 0x64, 0x61, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x49, 0x01, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x00, 0x01, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x00, 0x01, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0xF7, 0xF7,
	0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7,
	0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0xF7, 0xF7,
	0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7,
	0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0xF7, 0xF7,
	0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7,
	0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0xF7, 0xF7,
	0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7,
	0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0xF7, 0xF7,
	0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7,
	0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0xF7, 0xF7,
	0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7,
	0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0xF7, 0xF7,
	0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7,
	0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0xF7, 0xF7,
	0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7,
	0xF7, 0xF7, 0xF7, 0xF7, 0xF7, 0xF7,
};
#define RCP_HDR_SIZE	sizeof(RCP_HEADER)
#define FUGA_HDR_SIZE	0x06

static UINT32 ROMLen;
static UINT8* ROMData;
static UINT32 MidLen;
static UINT8* MidData;

static UINT8 DECRYPT_KEY = 0xA5;
static UINT8 CLEAN_RCP = 0;
static const char* CTRL_FILE = NULL;

int main(int argc, char* argv[])
{
	int argbase;
	FILE* hFile;
	UINT8 retVal;
	
	printf("FUGA Systems MIDI -> RCP Converter\n----------------------------------\n");
	if (argc < 3)
	{
		printf("Usage: fuga2rcp.exe [options] input.bin output.mid\n");
		printf("Options:\n");
		printf("    -Key n      specify decryption key (default: 0x%02X)\n", DECRYPT_KEY);
		printf("    -Clean      clean up RCP file by stripping trailing garbage\n");
		printf("    -Ctrl f.cm6 specify RCP Control File name\n");
		return 0;
	}
	
	argbase = 1;
	while(argbase < argc && argv[argbase][0] == '-')
	{
		if (! stricmp(argv[argbase] + 1, "Key"))
		{
			argbase ++;
			if (argbase < argc)
				DECRYPT_KEY = (UINT8)strtoul(argv[argbase], NULL, 0);
		}
		else if (! stricmp(argv[argbase] + 1, "Clean"))
		{
			CLEAN_RCP = 1;
		}
		else if (! stricmp(argv[argbase] + 1, "Ctrl"))
		{
			argbase ++;
			if (argbase < argc)
				CTRL_FILE = argv[argbase];
		}
		else
			break;
		argbase ++;
	}
	if (argc < argbase + 2)
	{
		printf("Not enough arguments.\n");
		return 0;
	}
	
	hFile = fopen(argv[argbase + 0], "rb");
	if (hFile == NULL)
	{
		printf("Error opening file!\n");
		return 1;
	}
	
	fseek(hFile, 0x00, SEEK_END);
	ROMLen = ftell(hFile);
	if (ROMLen > 0x100000)	// 1 MB
		ROMLen = 0x100000;
	
	fseek(hFile, 0x00, SEEK_SET);
	ROMData = (UINT8*)malloc(ROMLen);
	fread(ROMData, 0x01, ROMLen, hFile);
	
	fclose(hFile);
	
	DecryptData(ROMLen, ROMData, DECRYPT_KEY);
	retVal = Fuga2Rcp(ROMLen, ROMData);
	if (! retVal)
		WriteFileData(MidLen, MidData, argv[argbase + 1]);
	free(MidData);	MidData = NULL;
	
	printf("Done.\n");
	
	free(ROMData);	ROMData = NULL;
	
#ifdef _DEBUG
	//getchar();
#endif
	
	return 0;
}

static UINT8 WriteFileData(UINT32 DataLen, const UINT8* Data, const char* FileName)
{
	FILE* hFile;
	
	hFile = fopen(FileName, "wb");
	if (hFile == NULL)
	{
		printf("Error opening %s!\n", FileName);
		return 0xFF;
	}
	
	fwrite(Data, 0x01, DataLen, hFile);
	fclose(hFile);
	
	return 0;
}


void DecryptData(UINT32 len, UINT8* data, UINT8 key)
{
	UINT32 curPos;
	for (curPos = 0x00; curPos < len; curPos ++)
		data[curPos] ^= key;
	return;
}

UINT8 Fuga2Rcp(UINT32 songLen, const UINT8* songData)
{
	MidLen = RCP_HDR_SIZE + songLen - FUGA_HDR_SIZE;
	MidData = (UINT8*)malloc(MidLen);
	
	memcpy(&MidData[0x0000], RCP_HEADER, RCP_HDR_SIZE);	// copy RCP header
	memcpy(&MidData[0x01C1], &songData[0x00], 0x05);	// copy tempo / beat information from FUGA file
	memcpy(&MidData[RCP_HDR_SIZE], &songData[FUGA_HDR_SIZE], songLen - FUGA_HDR_SIZE);	// copy FUGA/RCP song data
	
	if (CTRL_FILE != NULL)
		strncpy((char*)&MidData[0x01C6], CTRL_FILE, 12);	// potential \0 padding is intentional
	
	if (CLEAN_RCP)
	{
		// The files in the Hoot archive contain garbage data at the end.
		// In order to remove that data, we walk through all tracks and
		// terminate the file after all 18 tracks.
		UINT8 curTrk;
		UINT32 curPos;
		
		curPos = RCP_HDR_SIZE;
		for (curTrk = 0; curTrk < 18; curTrk ++)
		{
			if (curPos >= MidLen)
				break;
			curPos += ReadLE16(&MidData[curPos]);	// increment by track length
		}
		if (curPos < MidLen)
			MidLen = curPos;
	}
	
	return 0x00;
}

static UINT16 ReadLE16(const UINT8* data)
{
	return (data[0x01] << 8) | (data[0x00] << 0);
}
